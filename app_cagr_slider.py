import streamlit as st
import pandas as pd
import numpy as np
import math

st.markdown("### ğŸ¯ æ¬¡ã®100å„„ä¼æ¥­ã‚’æ¢ã›ï¼")
st.caption("2022ã€œ2024å¹´ä¸Šå ´ã‚°ãƒ­ãƒ¼ã‚¹éŠ˜æŸ„ã®æˆé•·åŠ›ã‚’å¤šæ®µéšã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°")

@st.cache_data
def load_data():
    df = pd.read_csv("data/next100_required_cagr_with_edinet.csv")
    df['ç²—åˆ©ç›Šç‡'] = np.where(
        df['å£²ä¸ŠåŸä¾¡'].isnull() | (df['å£²ä¸ŠåŸä¾¡'] == 0),
        1.0,
        (df['å£²ä¸Šé«˜'] - df['å£²ä¸ŠåŸä¾¡']) / df['å£²ä¸Šé«˜']
    )
    df['ç²—åˆ©ç›Šç‡'] = (df['ç²—åˆ©ç›Šç‡'] * 100).round(2)
    df['æ™‚ä¾¡ç·é¡'] = df['æ™‚ä¾¡ç·é¡(ç™¾ä¸‡å††)']
    return df

df = load_data()

# ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼â‘ ï¼šå¿…è¦CAGR
min_cagr = int(df["å¿…è¦CAGR(%)"].min())
max_cagr = math.ceil(df["å¿…è¦CAGR(%)"].max())
cagr_range = st.slider("å¿…è¦CAGR(%)ã®ç¯„å›²ã‚’é¸æŠï¼ˆ5å¹´å¾Œã«æ™‚ä¾¡ç·é¡100å„„å††ã‚’ç›®æŒ‡ã™ï¼‰", min_cagr, max_cagr, (min_cagr, max_cagr), step=1)

max_selected_cagr = cagr_range[1]
if max_selected_cagr <= 20:
    st.success("ğŸŸ¢ å®Ÿç¾å¯èƒ½ãªæ°´æº–ã€‚éå»ã«ã‚‚å¤šãã®ä¼æ¥­ãŒåˆ°é”ã—ã¦ã„ã¾ã™ã€‚")
elif max_selected_cagr <= 30:
    st.info("ğŸŸ¡ é ‘å¼µã‚Œã°ç‹™ãˆã‚‹ã‚¾ãƒ¼ãƒ³ã€‚ãŸã ã—æˆé•·æˆ¦ç•¥ã®ç²¾æŸ»ãŒå¿…è¦ã€‚")
elif max_selected_cagr <= 40:
    st.warning("ğŸŸ  é«˜æˆé•·ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹é ˜åŸŸã€‚æˆåŠŸä¼æ¥­ã¯é™ã‚‰ã‚Œã¾ã™ã€‚")
else:
    st.error("ğŸ”´ æ¥µã‚ã¦é«˜ã„æˆé•·ç‡ãŒå¿…è¦ã€‚ç¾å®Ÿçš„ã‹ã©ã†ã‹æ…é‡ã«æ¤œè¨ã‚’ã€‚")

filtered = df[(df["å¿…è¦CAGR(%)"] >= cagr_range[0]) & (df["å¿…è¦CAGR(%)"] <= cagr_range[1])]

# ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼â‘¡ï¼šå£²ä¸Šé«˜
sales_min = int(df["å£²ä¸Šé«˜"].min())
sales_max = int(df["å£²ä¸Šé«˜"].max())
sales_lower = st.slider("å£²ä¸Šé«˜ï¼ˆç™¾ä¸‡å††ï¼‰ãŒã“ã®å€¤ä»¥ä¸Šã®ä¼æ¥­ã®ã¿è¡¨ç¤º", sales_min, sales_max, sales_min, step=100)

if sales_lower < 1000:
    st.error("ğŸ”´ å£²ä¸Šé«˜ãŒå°ã•ã„ãŸã‚ã€ã‚¹ã‚±ãƒ¼ãƒ«ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
elif sales_lower < 3000:
    st.warning("ğŸŸ  å£²ä¸Šé«˜ã¯ã‚ã‚‹ç¨‹åº¦ã‚ã‚‹ãŒã€é»’å­—åŒ–ã«ã¯æ…é‡ãªè¦‹æ¥µã‚ãŒå¿…è¦ã§ã™ã€‚")
elif sales_lower < 5000:
    st.info("ğŸŸ¡ ä¸€å®šã®å£²ä¸Šè¦æ¨¡ã‚ã‚Šã€‚æˆé•·æˆ¦ç•¥æ¬¡ç¬¬ã§ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—å¯èƒ½ã€‚")
elif sales_lower < 10000:
    st.success("ğŸŸ¢ å£²ä¸Šè¦æ¨¡ã¯ååˆ†ã€‚ç²—åˆ©ãƒ»æˆ¦ç•¥æ¬¡ç¬¬ã§100å„„å††ãŒè¦–é‡ã«å…¥ã‚Šã¾ã™ã€‚")
else:
    st.success("ğŸ’ å£²ä¸Š10å„„è¶…ã€‚è¦æ¨¡ã¨äº‹æ¥­æ§‹é€ ãŒå‚™ã‚ã£ã¦ã„ã‚Œã°æœ‰åŠ›å€™è£œã§ã™ã€‚")

filtered = filtered[filtered["å£²ä¸Šé«˜"] >= sales_lower]

# ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼â‘¢ï¼šç²—åˆ©ç›Šç‡
st.markdown("### ğŸ’¡ ç²—åˆ©ç›Šç‡ã§ã•ã‚‰ã«çµã‚Šè¾¼ã‚€")
gp_min = 0
gp_max = 100
gp_lower = st.slider("ç²—åˆ©ç›Šç‡(%)ãŒã“ã®å€¤ä»¥ä¸Šã®ä¼æ¥­ã®ã¿è¡¨ç¤ºï¼ˆ1%åˆ»ã¿ï¼‰", gp_min, gp_max, gp_min, step=1)
if gp_lower < 20:
    st.error("ğŸ”´ ç²—åˆ©ç›Šç‡ãŒæ¥µç«¯ã«ä½ã„ã‚¾ãƒ¼ãƒ³ã€‚ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã®å†è€ƒãŒå¿…è¦ã€‚")
elif gp_lower < 40:
    st.warning("ğŸŸ  ç«¶äº‰ãŒæ¿€ã—ãã‚³ã‚¹ãƒˆãŒé‡ã„ãƒ“ã‚¸ãƒã‚¹ã€‚åŠ¹ç‡åŒ–ã‚„ä»˜åŠ ä¾¡å€¤ãŒèª²é¡Œã€‚")
elif gp_lower < 60:
    st.info("ğŸŸ¡ ä¸€èˆ¬çš„ãªä¸Šå ´ä¼æ¥­ã®ç²—åˆ©ç›Šç‡æ°´æº–ã€‚äº‹æ¥­æ‹¡å¤§æ¬¡ç¬¬ã§é«˜åç›ŠåŒ–ã‚‚ç‹™ãˆã‚‹ã€‚")
elif gp_lower < 80:
    st.success("ğŸŸ¢ é«˜ç²—åˆ©ç›Šç‡ã€‚ã‚µãƒ¼ãƒ“ã‚¹å‹ã‚„å¼·ã„ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›ã‚’æŒã¤ä¼æ¥­ã€‚")
else:
    st.success("ğŸ’ æ¥µã‚ã¦é«˜ã„ç²—åˆ©ç›Šç‡ã€‚ä»˜åŠ ä¾¡å€¤ãŒé«˜ãã€ç«¶äº‰å„ªä½æ€§ãŒéš›ç«‹ã¤ãƒ“ã‚¸ãƒã‚¹ã€‚")
filtered = filtered[filtered["ç²—åˆ©ç›Šç‡"] >= gp_lower]

# ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼â‘£ï¼šå–¶æ¥­åˆ©ç›Š
op_min = int(df["å–¶æ¥­åˆ©ç›Š"].min())
op_max = int(df["å–¶æ¥­åˆ©ç›Š"].max())
op_lower = st.slider("å–¶æ¥­åˆ©ç›Šï¼ˆç™¾ä¸‡å††ï¼‰ãŒã“ã®å€¤ä»¥ä¸Šã®ä¼æ¥­", op_min, op_max, op_min, step=100)

if op_lower < -1000:
    st.error("ğŸ”´ å¤§å¹…ãªå–¶æ¥­èµ¤å­—ã€‚æ—©æœŸã®åç›Šæ”¹å–„ãŒä¸å¯æ¬ ã§ã™ã€‚")
elif op_lower < 0:
    st.warning("ğŸŸ  å–¶æ¥­èµ¤å­—ã€‚é«˜ç²—åˆ©ã§ã‚‚è²©ç®¡è²»ã«èª²é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚")
elif op_lower < 500:
    st.info("ğŸŸ¡ é»’å­—åŒ–æ¸ˆã¿ã€‚åˆ©ç›Šã®ç©ã¿ä¸Šã’ã«æ³¨ç›®ã€‚")
elif op_lower < 2000:
    st.success("ğŸŸ¢ å–¶æ¥­åˆ©ç›Šã¯é †èª¿ã€‚æ‹¡å¤§ãƒ•ã‚§ãƒ¼ã‚ºã«å…¥ã‚Šã¤ã¤ã‚ã‚Šã¾ã™ã€‚")
else:
    st.success("ğŸ’ é«˜ã„å–¶æ¥­åˆ©ç›Šæ°´æº–ã€‚ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã™ã€‚")

filtered = filtered[filtered["å–¶æ¥­åˆ©ç›Š"] >= op_lower]

# ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼â‘¤ï¼šå–¶æ¥­CF
cf_min = int(df["å–¶æ¥­CF"].min())
cf_max = int(df["å–¶æ¥­CF"].max())
cf_lower = st.slider("å–¶æ¥­ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ï¼ˆç™¾ä¸‡å††ï¼‰ãŒã“ã®å€¤ä»¥ä¸Šã®ä¼æ¥­", cf_min, cf_max, cf_min, step=100)

if cf_lower < -1000:
    st.error("ğŸ”´ å¤§ããªå–¶æ¥­ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ã‚¦ãƒˆã€‚è³‡é‡‘ç¹°ã‚Šã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚")
elif cf_lower < 0:
    st.warning("ğŸŸ  ã‚­ãƒ£ãƒƒã‚·ãƒ¥æµå‡ºä¸­ã€‚æˆé•·æŠ•è³‡ä¸­ã§ã‚ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚")
elif cf_lower < 500:
    st.info("ğŸŸ¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥é»’å­—ã€‚å …å®Ÿãªã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¼ºãˆã¾ã™ã€‚")
elif cf_lower < 2000:
    st.success("ğŸŸ¢ å®‰å®šã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç”Ÿã¿å‡ºã—ã¦ã„ã¾ã™ã€‚")
else:
    st.success("ğŸ’ å¼·åŠ›ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰µå‡ºåŠ›ã€‚æŠ•è³‡ä½™åŠ›ã‚‚ååˆ†ã§ã™ã€‚")

filtered = filtered[filtered["å–¶æ¥­CF"] >= cf_lower]

# ã‚¿ã‚°è¡¨ç¤ºç”¨é–¢æ•°
def generate_tags(row):
    tags = []
    if row["å–¶æ¥­åˆ©ç›Š"] > 0:
        tags.append("ğŸŸ¢é»’å­—")
    if row["å–¶æ¥­CF"] > 0:
        tags.append("ğŸ’°CFé»’å­—")
    if row["ç²—åˆ©ç›Šç‡"] >= 60:
        tags.append("ğŸ’é«˜ç²—åˆ©")
    return " ".join(tags)

filtered["è©•ä¾¡ã‚¿ã‚°"] = filtered.apply(generate_tags, axis=1)

# è¡¨ç¤ºåˆ—
show_cols = ['è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰', 'ä¼æ¥­å', 'æ™‚ä¾¡ç·é¡', 'å£²ä¸Šé«˜', 'å¿…è¦CAGR(%)', 'ç²—åˆ©ç›Šç‡', 'å–¶æ¥­åˆ©ç›Š', 'å–¶æ¥­CF', 'è©•ä¾¡ã‚¿ã‚°']
st.markdown(f"#### ğŸ¯ æ¡ä»¶ã«åˆè‡´ã™ã‚‹ä¼æ¥­ä¸€è¦§ï¼š{len(filtered)}ä»¶")
st.dataframe(filtered[show_cols].reset_index(drop=True), use_container_width=True)
