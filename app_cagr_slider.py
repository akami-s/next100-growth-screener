import streamlit as st
import pandas as pd
import numpy as np
import math

st.markdown("### ğŸ¯ æ¬¡ã®100å„„ä¼æ¥­ã‚’æ¢ã›ï¼")
st.caption("2022ã€œ2024å¹´ä¸Šå ´ã‚°ãƒ­ãƒ¼ã‚¹éŠ˜æŸ„ã®æˆé•·åŠ›ã‚’å¤šæ®µéšã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°")

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
@st.cache_data
def load_data():
    df = pd.read_csv("data/next100_required_cagr_with_edinet.csv")
    # ç²—åˆ©ç›Šç‡è¨ˆç®—ï¼ˆå£²ä¸ŠåŸä¾¡ãŒç©ºæ¬„/0ãªã‚‰100ï¼…ï¼‰
    df['ç²—åˆ©ç›Šç‡'] = np.where(
        df['å£²ä¸ŠåŸä¾¡'].isnull() | (df['å£²ä¸ŠåŸä¾¡'] == 0),
        1.0,
        (df['å£²ä¸Šé«˜'] - df['å£²ä¸ŠåŸä¾¡']) / df['å£²ä¸Šé«˜']
    )
    df['ç²—åˆ©ç›Šç‡'] = (df['ç²—åˆ©ç›Šç‡'] * 100).round(2)
    # è¡¨ç¤ºç”¨ã«ã€Œæ™‚ä¾¡ç·é¡ã€ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆå…ƒã¯ã€Œæ™‚ä¾¡ç·é¡(ç™¾ä¸‡å††)ã€ï¼‰
    df['æ™‚ä¾¡ç·é¡'] = df['æ™‚ä¾¡ç·é¡(ç™¾ä¸‡å††)']
    return df

df = load_data()

# å¿…è¦CAGR(%) ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
min_cagr = int(df["å¿…è¦CAGR(%)"].min())
max_cagr = math.ceil(df["å¿…è¦CAGR(%)"].max())

cagr_range = st.slider(
    "å¿…è¦CAGR(%)ã®ç¯„å›²ã‚’é¸æŠï¼ˆ5å¹´å¾Œã«æ™‚ä¾¡ç·é¡100å„„å††ã‚’ç›®æŒ‡ã™ï¼‰",
    min_value=min_cagr,
    max_value=max_cagr,
    value=(min_cagr, max_cagr),
    step=1,
)

# è‰²ä»˜ãã‚³ãƒ¡ãƒ³ãƒˆ
max_selected_cagr = cagr_range[1]
if max_selected_cagr <= 20:
    st.success("ğŸŸ¢ å®Ÿç¾å¯èƒ½ãªæ°´æº–ã€‚éå»ã«ã‚‚å¤šãã®ä¼æ¥­ãŒåˆ°é”ã—ã¦ã„ã¾ã™ã€‚")
elif max_selected_cagr <= 30:
    st.info("ğŸŸ¡ é ‘å¼µã‚Œã°ç‹™ãˆã‚‹ã‚¾ãƒ¼ãƒ³ã€‚ãŸã ã—æˆé•·æˆ¦ç•¥ã®ç²¾æŸ»ãŒå¿…è¦ã€‚")
elif max_selected_cagr <= 40:
    st.warning("ğŸŸ  é«˜æˆé•·ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹é ˜åŸŸã€‚æˆåŠŸä¼æ¥­ã¯é™ã‚‰ã‚Œã¾ã™ã€‚")
else:
    st.error("ğŸ”´ æ¥µã‚ã¦é«˜ã„æˆé•·ç‡ãŒå¿…è¦ã€‚ç¾å®Ÿçš„ã‹ã©ã†ã‹æ…é‡ã«æ¤œè¨ã‚’ã€‚")

# ã¾ãšCAGRæ¡ä»¶ã§çµã‚Šè¾¼ã¿
filtered_cagr = df[(df["å¿…è¦CAGR(%)"] >= cagr_range[0]) & (df["å¿…è¦CAGR(%)"] <= cagr_range[1])]

# è¡¨ç¤ºã‚«ãƒ©ãƒ 
show_cols = ['è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰', 'ä¼æ¥­å', 'æ™‚ä¾¡ç·é¡', 'æ®‹ã‚Šå¹´æ•°', 'å¿…è¦CAGR(%)', 'ç²—åˆ©ç›Šç‡']

# ä»¶æ•°è¡¨ç¤ºã‚’è¿½åŠ 
st.markdown(f"#### ğŸš€ å¿…è¦CAGR(%)æ¡ä»¶ã«åˆè‡´ã™ã‚‹ä¼æ¥­ä¸€è¦§ï¼š{len(filtered_cagr)}ä»¶")
st.dataframe(filtered_cagr[show_cols].reset_index(drop=True), use_container_width=True)

# ã‚«ãƒ©ãƒ è£œè¶³èª¬æ˜
with st.expander("ã€ã‚«ãƒ©ãƒ ã®è£œè¶³èª¬æ˜ã€‘"):
    st.markdown("""
- **è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰**ï¼šä¸Šå ´æ™‚ã®è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰
- **ä¼æ¥­å**ï¼šä¸Šå ´ä¼æ¥­å
- **æ™‚ä¾¡ç·é¡**ï¼š2025å¹´6æœˆ5æ—¥æ™‚ç‚¹ã®æ™‚ä¾¡ç·é¡ï¼ˆ**å˜ä½ï¼šç™¾ä¸‡å††**ï¼‰
- **æ®‹ã‚Šå¹´æ•°**ï¼šã€Œ5å¹´å¾Œ100å„„å††ã€é”æˆã¾ã§æ®‹ã‚‹å¹´æ•°
- **å¿…è¦CAGR(%)**ï¼šä»Šã®æ™‚ä¾¡ç·é¡ã‹ã‚‰5å¹´å¾Œ100å„„å††ã«åˆ°é”ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå¹´å¹³å‡æˆé•·ç‡
- **ç²—åˆ©ç›Šç‡**ï¼šå£²ä¸Šç·åˆ©ç›Š Ã· å£²ä¸Šé«˜ï¼ˆå£²ä¸ŠåŸä¾¡ãŒç©ºæ¬„/ã‚¼ãƒ­ã®å ´åˆã¯100%ã¨ã—ã¦è‡ªå‹•è¨ˆç®—ï¼‰
""")

# --- ç²—åˆ©ç›Šç‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆä¸‹é™ã®ã¿æŒ‡å®šï¼‰ ---
st.markdown("### ğŸ’¡ ç²—åˆ©ç›Šç‡ã§ã•ã‚‰ã«çµã‚Šè¾¼ã‚€")
gp_min = 0
gp_max = 100

gp_lower = st.slider(
    "ç²—åˆ©ç›Šç‡(%)ãŒã“ã®å€¤ä»¥ä¸Šã®ä¼æ¥­ã®ã¿è¡¨ç¤ºï¼ˆ1%åˆ»ã¿ï¼‰",
    min_value=gp_min,
    max_value=gp_max,
    value=gp_min,
    step=1,
)

# ç²—åˆ©ç›Šç‡ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä¸‹é™ã§åˆ‡ã‚Šæ›¿ãˆï¼‰
if gp_lower < 20:
    st.error("ğŸ”´ ç²—åˆ©ç›Šç‡ãŒæ¥µç«¯ã«ä½ã„ã‚¾ãƒ¼ãƒ³ã€‚ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã®å†è€ƒãŒå¿…è¦ã€‚")
elif gp_lower < 40:
    st.warning("ğŸŸ  ç«¶äº‰ãŒæ¿€ã—ãã‚³ã‚¹ãƒˆãŒé‡ã„ãƒ“ã‚¸ãƒã‚¹ã€‚åŠ¹ç‡åŒ–ã‚„ä»˜åŠ ä¾¡å€¤ãŒèª²é¡Œã€‚")
elif gp_lower < 60:
    st.info("ğŸŸ¡ ä¸€èˆ¬çš„ãªä¸Šå ´ä¼æ¥­ã®ç²—åˆ©ç›Šç‡æ°´æº–ã€‚äº‹æ¥­æ‹¡å¤§æ¬¡ç¬¬ã§é«˜åç›ŠåŒ–ã‚‚ç‹™ãˆã‚‹ã€‚")
elif gp_lower < 80:
    st.success("ğŸŸ¢ é«˜ç²—åˆ©ç›Šç‡ã€‚ã‚µãƒ¼ãƒ“ã‚¹å‹ã‚„å¼·ã„ãƒ–ãƒ©ãƒ³ãƒ‰åŠ›ã‚’æŒã¤ä¼æ¥­ã€‚")
else:
    st.success("ğŸ’ æ¥µã‚ã¦é«˜ã„ç²—åˆ©ç›Šç‡ã€‚ä»˜åŠ ä¾¡å€¤ãŒé«˜ãã€ç«¶äº‰å„ªä½æ€§ãŒéš›ç«‹ã¤ãƒ“ã‚¸ãƒã‚¹ã€‚")

filtered_both = filtered_cagr[filtered_cagr["ç²—åˆ©ç›Šç‡"] >= gp_lower]

# ä»¶æ•°è¡¨ç¤ºã‚’è¿½åŠ 
st.markdown(f"#### ğŸ¯ å¿…è¦CAGR(%) Ã— ç²—åˆ©ç›Šç‡ æ¡ä»¶ã«åˆè‡´ã™ã‚‹ä¼æ¥­ä¸€è¦§ï¼š{len(filtered_both)}ä»¶")
st.dataframe(filtered_both[show_cols].reset_index(drop=True), use_container_width=True)
